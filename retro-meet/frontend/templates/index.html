<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RetroMeet - AI-Powered Retrospective Meetings</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f8f9fa;
        }
        .header {
            background-color: #6c5ce7;
            color: white;
            padding: 2rem 0;
            margin-bottom: 2rem;
        }
        .card {
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            margin-bottom: 20px;
            transition: transform 0.3s ease;
        }
        .card:hover {
            transform: translateY(-5px);
        }
        .video-container {
            position: relative;
            padding-bottom: 56.25%;
            height: 0;
            overflow: hidden;
            border-radius: 10px 10px 0 0;
        }
        .video-container video {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        .btn-primary {
            background-color: #6c5ce7;
            border-color: #6c5ce7;
        }
        .btn-primary:hover {
            background-color: #5649c0;
            border-color: #5649c0;
        }
        .participant-avatar {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            object-fit: cover;
            margin-right: 10px;
        }
        .participant-info {
            display: flex;
            align-items: center;
            margin-bottom: 10px;
        }
    </style>
</head>
<body>
    <div class="header text-center">
        <div class="container">
            <h1>RetroMeet</h1>
            <p class="lead">AI-Powered Retrospective Meetings with Lip-Synced Videos</p>
        </div>
    </div>

    <div class="container">
        <div class="row mb-4">
            <div class="col-md-6">
                <div class="card">
                    <div class="card-body">
                        <h5 class="card-title">Collect Responses</h5>
                        <p class="card-text">Share the chat link with your team to collect their retrospective responses.</p>
                        <a href="http://localhost:7860" target="_blank" class="btn btn-primary">Open Chat Interface</a>
                    </div>
                </div>
            </div>
            <div class="col-md-6">
                <div class="card">
                    <div class="card-body">
                        <h5 class="card-title">Manage Participants</h5>
                        <p class="card-text">Add new participants and assign avatars to them.</p>
                        <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#participantModal">
                            Manage Participants
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <div class="row mb-4">
            <div class="col-md-6">
                <h2 class="mb-4">All Responses</h2>
                <div class="card">
                    <div class="card-body">
                        <div id="responses-container">
                            <!-- Responses will be loaded here dynamically -->
                            <div class="text-center" id="no-responses-message">
                                <p>No responses have been collected yet.</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-6">
                <h2 class="mb-4">Generated Videos</h2>
                <div class="row" id="videos-container">
                    <!-- Videos will be loaded here dynamically -->
                    <div class="col-12 text-center" id="no-videos-message">
                        <p>No videos have been generated yet.</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Participant Modal -->
    <div class="modal fade" id="participantModal" tabindex="-1" aria-labelledby="participantModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="participantModalLabel">Manage Participants</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="row mb-4">
                        <div class="col">
                            <h6>Add New Participant</h6>
                            <form id="add-participant-form">
                                <div class="mb-3">
                                    <label for="participant-name" class="form-label">Name</label>
                                    <input type="text" class="form-control" id="participant-name" required>
                                </div>
                                <div class="mb-3">
                                    <label for="participant-avatar" class="form-label">Avatar (Optional)</label>
                                    <input type="file" class="form-control" id="participant-avatar" accept="image/*">
                                </div>
                                <button type="submit" class="btn btn-primary">Add Participant</button>
                            </form>
                        </div>
                    </div>
                    <hr>
                    <div class="row">
                        <div class="col">
                            <h6>Current Participants</h6>
                            <div id="participants-list">
                                <!-- Participants will be loaded here dynamically -->
                                <p id="no-participants-message">No participants added yet.</p>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // API URL
        const API_URL = 'http://localhost:8000';
        
        // Function to load participants
        async function loadParticipants() {
            try {
                const response = await fetch(`${API_URL}/participants/`);
                const participants = await response.json();
                
                const participantsList = document.getElementById('participants-list');
                const noParticipantsMessage = document.getElementById('no-participants-message');
                
                if (participants.length > 0) {
                    noParticipantsMessage.style.display = 'none';
                    participantsList.innerHTML = '';
                    
                    participants.forEach(participant => {
                        const participantElement = document.createElement('div');
                        participantElement.className = 'participant-info mb-3 p-2 border rounded';
                        
                        let avatarHtml = '';
                        if (participant.avatar_path) {
                            const avatarUrl = participant.avatar_path.replace('frontend', '');
                            avatarHtml = `<img src="${avatarUrl}" class="participant-avatar" alt="${participant.name}">`;
                        } else {
                            avatarHtml = `<div class="participant-avatar bg-secondary d-flex align-items-center justify-content-center text-white">
                                            ${participant.name.charAt(0).toUpperCase()}
                                          </div>`;
                        }
                        
                        participantElement.innerHTML = `
                            <div class="d-flex align-items-center justify-content-between">
                                <div class="d-flex align-items-center">
                                    ${avatarHtml}
                                    <span>${participant.name}</span>
                                </div>
                                <button class="btn btn-sm btn-outline-primary assign-avatar-btn" data-participant-id="${participant.id}">
                                    Assign Avatar
                                </button>
                            </div>
                        `;
                        
                        participantsList.appendChild(participantElement);
                    });
                    
                    // Add event listeners to assign avatar buttons
                    document.querySelectorAll('.assign-avatar-btn').forEach(button => {
                        button.addEventListener('click', () => {
                            // Open avatar selection for this participant
                            openAvatarSelection(button.dataset.participantId);
                        });
                    });
                } else {
                    noParticipantsMessage.style.display = 'block';
                    participantsList.innerHTML = '';
                }
            } catch (error) {
                console.error('Error loading participants:', error);
            }
        }
        
        // Function to load all responses
        async function loadResponses() {
            try {
                const response = await fetch(`${API_URL}/responses/`);
                const responses = await response.json();
                
                const responsesContainer = document.getElementById('responses-container');
                const noResponsesMessage = document.getElementById('no-responses-message');
                
                if (responses.length > 0) {
                    noResponsesMessage.style.display = 'none';
                    responsesContainer.innerHTML = '';
                    
                    // Group responses by participant
                    const responsesByParticipant = {};
                    responses.forEach(response => {
                        if (!responsesByParticipant[response.participant_id]) {
                            responsesByParticipant[response.participant_id] = [];
                        }
                        responsesByParticipant[response.participant_id].push(response);
                    });
                    
                    // Create an accordion for each participant
                    let accordionId = 'responsesAccordion';
                    const accordion = document.createElement('div');
                    accordion.className = 'accordion';
                    accordion.id = accordionId;
                    
                    let accordionItemIndex = 0;
                    
                    // For each participant, create an accordion item
                    for (const participantId in responsesByParticipant) {
                        const participantResponses = responsesByParticipant[participantId];
                        
                        // Get participant info from the first response
                        const firstResponse = participantResponses[0];
                        
                        // Create accordion item
                        const accordionItem = document.createElement('div');
                        accordionItem.className = 'accordion-item';
                        
                        // Create header
                        const headerId = `heading${accordionItemIndex}`;
                        const accordionHeader = document.createElement('h2');
                        accordionHeader.className = 'accordion-header';
                        accordionHeader.id = headerId;
                        
                        // Create button
                        const button = document.createElement('button');
                        button.className = 'accordion-button collapsed';
                        button.type = 'button';
                        button.setAttribute('data-bs-toggle', 'collapse');
                        button.setAttribute('data-bs-target', `#collapse${accordionItemIndex}`);
                        button.setAttribute('aria-expanded', 'false');
                        button.setAttribute('aria-controls', `collapse${accordionItemIndex}`);
                        
                        // Get participant name
                        const participantName = firstResponse.participant ? firstResponse.participant.name : `Participant ${participantId}`;
                        button.textContent = `${participantName} (${participantResponses.length} responses)`;
                        
                        accordionHeader.appendChild(button);
                        accordionItem.appendChild(accordionHeader);
                        
                        // Create collapse div
                        const collapseDiv = document.createElement('div');
                        collapseDiv.id = `collapse${accordionItemIndex}`;
                        collapseDiv.className = 'accordion-collapse collapse';
                        collapseDiv.setAttribute('aria-labelledby', headerId);
                        collapseDiv.setAttribute('data-bs-parent', `#${accordionId}`);
                        
                        // Create accordion body
                        const accordionBody = document.createElement('div');
                        accordionBody.className = 'accordion-body';
                        
                        // Add each response
                        participantResponses.forEach(response => {
                            const responseDiv = document.createElement('div');
                            responseDiv.className = 'card mb-3';
                            
                            const cardBody = document.createElement('div');
                            cardBody.className = 'card-body';
                            
                            const questionHeading = document.createElement('h5');
                            questionHeading.className = 'card-title';
                            questionHeading.textContent = response.question;
                            
                            const responseText = document.createElement('p');
                            responseText.className = 'card-text';
                            responseText.textContent = response.refined_response || response.original_response;
                            
                            cardBody.appendChild(questionHeading);
                            cardBody.appendChild(responseText);
                            
                            // Add audio player if available
                            if (response.audio_path) {
                                const audioUrl = response.audio_path.replace('frontend', '');
                                const audioPlayer = document.createElement('audio');
                                audioPlayer.controls = true;
                                audioPlayer.className = 'w-100 mt-2';
                                
                                const audioSource = document.createElement('source');
                                audioSource.src = audioUrl;
                                audioSource.type = 'audio/mpeg';
                                
                                audioPlayer.appendChild(audioSource);
                                cardBody.appendChild(audioPlayer);
                            }
                            
                            responseDiv.appendChild(cardBody);
                            accordionBody.appendChild(responseDiv);
                        });
                        
                        collapseDiv.appendChild(accordionBody);
                        accordionItem.appendChild(collapseDiv);
                        accordion.appendChild(accordionItem);
                        
                        accordionItemIndex++;
                    }
                    
                    responsesContainer.appendChild(accordion);
                } else {
                    noResponsesMessage.style.display = 'block';
                    responsesContainer.innerHTML = '';
                    responsesContainer.appendChild(noResponsesMessage);
                }
            } catch (error) {
                console.error('Error loading responses:', error);
            }
        }
        
        // Function to load videos
        async function loadVideos() {
            try {
                const response = await fetch(`${API_URL}/responses/`);
                const responses = await response.json();
                
                const videosContainer = document.getElementById('videos-container');
                const noVideosMessage = document.getElementById('no-videos-message');
                
                // Filter responses that have videos
                const videosResponses = responses.filter(response => response.video_path);
                
                if (videosResponses.length > 0) {
                    noVideosMessage.style.display = 'none';
                    videosContainer.innerHTML = '';
                    
                    videosResponses.forEach(response => {
                        const videoElement = document.createElement('div');
                        videoElement.className = 'col-md-6 col-lg-4 mb-4';
                        
                        const videoUrl = response.video_path.replace('frontend', '');
                        
                        videoElement.innerHTML = `
                            <div class="card">
                                <div class="video-container">
                                    <video controls>
                                        <source src="${videoUrl}" type="video/mp4">
                                        Your browser does not support the video tag.
                                    </video>
                                </div>
                                <div class="card-body">
                                    <h5 class="card-title">${response.question}</h5>
                                    <p class="card-text">${response.refined_response || response.original_response}</p>
                                </div>
                            </div>
                        `;
                        
                        videosContainer.appendChild(videoElement);
                    });
                } else {
                    noVideosMessage.style.display = 'block';
                    videosContainer.innerHTML = '';
                    videosContainer.appendChild(noVideosMessage);
                }
            } catch (error) {
                console.error('Error loading videos:', error);
            }
        }
        
        // Function to add a new participant
        async function addParticipant(name, avatarFile) {
            try {
                let participant = { name };
                
                // If avatar file is provided, upload it first
                if (avatarFile) {
                    const formData = new FormData();
                    formData.append('file', avatarFile);
                    
                    const uploadResponse = await fetch(`${API_URL}/participants/avatars`, {
                        method: 'POST',
                        body: formData
                    });
                    
                    if (uploadResponse.ok) {
                        const avatarData = await uploadResponse.json();
                        participant.avatar_filename = avatarData.filename;
                    } else {
                        throw new Error('Failed to upload avatar');
                    }
                }
                
                // Create the participant
                const response = await fetch(`${API_URL}/participants/`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(participant)
                });
                
                if (response.ok) {
                    // Reload participants list
                    loadParticipants();
                    
                    // Clear form
                    document.getElementById('participant-name').value = '';
                    document.getElementById('participant-avatar').value = '';
                } else {
                    throw new Error('Failed to add participant');
                }
            } catch (error) {
                console.error('Error adding participant:', error);
                alert('Failed to add participant: ' + error.message);
            }
        }
        
        // Function to open avatar selection for a participant
        async function openAvatarSelection(participantId) {
            try {
                const response = await fetch(`${API_URL}/participants/avatars`);
                const avatars = await response.json();
                
                if (avatars.length > 0) {
                    // Create a modal to select an avatar
                    const modalHtml = `
                        <div class="modal fade" id="avatarSelectionModal" tabindex="-1" aria-hidden="true">
                            <div class="modal-dialog">
                                <div class="modal-content">
                                    <div class="modal-header">
                                        <h5 class="modal-title">Select Avatar</h5>
                                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                                    </div>
                                    <div class="modal-body">
                                        <div class="row">
                                            ${avatars.map(avatar => `
                                                <div class="col-4 mb-3">
                                                    <img src="/static/avatars/${avatar.filename}" class="img-fluid rounded avatar-option" 
                                                         data-filename="${avatar.filename}" alt="Avatar option">
                                                </div>
                                            `).join('')}
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                    
                    // Add the modal to the document
                    const modalContainer = document.createElement('div');
                    modalContainer.innerHTML = modalHtml;
                    document.body.appendChild(modalContainer);
                    
                    // Show the modal
                    const modal = new bootstrap.Modal(document.getElementById('avatarSelectionModal'));
                    modal.show();
                    
                    // Add click event to avatar options
                    document.querySelectorAll('.avatar-option').forEach(avatar => {
                        avatar.addEventListener('click', async () => {
                            try {
                                const filename = avatar.dataset.filename;
                                
                                const response = await fetch(`${API_URL}/participants/${participantId}/avatar`, {
                                    method: 'PUT',
                                    headers: {
                                        'Content-Type': 'application/json'
                                    },
                                    body: JSON.stringify({ filename })
                                });
                                
                                if (response.ok) {
                                    // Close the modal
                                    modal.hide();
                                    
                                    // Remove the modal from the document
                                    document.body.removeChild(modalContainer);
                                    
                                    // Reload participants
                                    loadParticipants();
                                } else {
                                    throw new Error('Failed to assign avatar');
                                }
                            } catch (error) {
                                console.error('Error assigning avatar:', error);
                                alert('Failed to assign avatar: ' + error.message);
                            }
                        });
                    });
                    
                    // Remove the modal from the document when it's hidden
                    document.getElementById('avatarSelectionModal').addEventListener('hidden.bs.modal', () => {
                        document.body.removeChild(modalContainer);
                    });
                } else {
                    alert('No avatars available. Please upload an avatar first.');
                }
            } catch (error) {
                console.error('Error opening avatar selection:', error);
                alert('Failed to load avatars: ' + error.message);
            }
        }
        
        // Event listeners
        document.addEventListener('DOMContentLoaded', () => {
            // Load participants, responses, and videos
            loadParticipants();
            loadResponses();
            loadVideos();
            
            // Add participant form submission
            document.getElementById('add-participant-form').addEventListener('submit', (e) => {
                e.preventDefault();
                const name = document.getElementById('participant-name').value;
                const avatarFile = document.getElementById('participant-avatar').files[0];
                addParticipant(name, avatarFile);
            });
            
            // Refresh data when the participant modal is shown
            document.getElementById('participantModal').addEventListener('shown.bs.modal', () => {
                loadParticipants();
            });
            
            // Set up auto-refresh for responses and videos
            setInterval(() => {
                loadResponses();
                loadVideos();
            }, 30000); // Refresh every 30 seconds
        });
    </script>
</body>
</html>
